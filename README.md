# thousands2

A new version of http://1000.southural.ru/ site - work in progress

## Legacy summit IDs (поддержка старых ссылок)

Механизм нужен для того, чтобы старые URL вершины продолжили работать после смены её «основного» ID (например при уточнении высоты и переименовании файла). 

### Как определяется текущий (актуальный) ID вершины
Всегда используется имя файла без расширения (`<summit_id>.yaml`).

### Что такое `legacy_ids`
Опциональный массив строк в YAML вершины:
```yaml
legacy_ids:
	- 1017
	- 1017-1
```
Каждое значение — старый ID, который раньше фигурировал в URL. Все они мапятся на текущий ID (имя файла). Эти значения:
1. Сохраняются в таблицу `summit_ids_legacy(legacy_id, summit_id)`.
2. Используются бэкендом при запросах вида `/api/summit/<ridge>/<legacy_id>`: если `legacy_id` найдено в таблице, возвращается объект вершины с уже НОВЫМ `id`.
3. После загрузки каталога все строки в `climbs`, где `summit_id` равен legacy, переписываются на новый ID.

### Ограничения и валидация
* `legacy_id` должен отличаться от текущего ID (одинаковые пропускаются).
* Поле `legacy_id` уникально (PRIMARY KEY). Если два YAML дадут один и тот же старый ID — загрузка упадёт, что позволяет вовремя заметить конфликт.
* Дубликаты внутри одного массива `legacy_ids` приведут к ошибке (вставка повторного primary key).

### Почему поле не возвращается в JSON
В структуре Go поле имеет тэг `json:"-"`, то есть скрыто во внешнем API. Клиенту нужен только актуальный ID; получение списка всех старых ID не требуется для обычной работы и только усложняет контракт. Логику редиректа клиент реализует простым сравнением: запрошенный ID vs. `summit.id` в ответе. Если они различаются — фронтенд обновляет URL через `router.replace(...)`.

### Пример изменения вершины
1. Был файл `stolby/1017.yaml` (ID = `1017`).
2. Высота уточнена, файл переименован в `stolby/1019.yaml` и изменено поле `height: 1019`.
3. В новый файл добавлено:
	 ```yaml
	 legacy_ids:
		 - 1017
	 ```
4. После `LoadSummits` запрос по `/stolby/1017` продолжит работать и вернёт вершину с `id = 1019`; фронтенд заменит URL.

### Минимальные действия администратора при изменении высоты без официального названия
1. Переименовать файл (новый ID = новая высота или иной формат по правилам проекта).
2. Обновить `height` внутри файла.
3. Добавить массив `legacy_ids` со старыми ID (можно несколько, если были последовательные изменения).

